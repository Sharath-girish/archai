
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>archai.datasets.providers.imagenet_folder &#8212; Archai  documentation</title>
    <link rel="stylesheet" href="../../../../_static/css/klink.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
         
        <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">
        
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono:400,500,700' rel='stylesheet' type='text/css'>
    
  </head><body>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for archai.datasets.providers.imagenet_folder</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) Microsoft Corporation.</span>
<span class="c1"># Licensed under the MIT license.</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">torch.utils.data.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torchvision.datasets.utils</span> <span class="kn">import</span> <span class="n">check_integrity</span><span class="p">,</span> <span class="n">download_url</span>


<span class="n">_ARCHIVE_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;train&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.image-net.org/challenges/LSVRC/2012/nnoupb/ILSVRC2012_img_train.tar&#39;</span><span class="p">,</span>
        <span class="s1">&#39;md5&#39;</span><span class="p">:</span> <span class="s1">&#39;1d675b47d978889d74fa0da5fadfb00e&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;val&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.image-net.org/challenges/LSVRC/2012/nnoupb/ILSVRC2012_img_val.tar&#39;</span><span class="p">,</span>
        <span class="s1">&#39;md5&#39;</span><span class="p">:</span> <span class="s1">&#39;29b22e2961454d5413ddabcf34fc5622&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;devkit&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.image-net.org/challenges/LSVRC/2012/nnoupb/ILSVRC2012_devkit_t12.tar.gz&#39;</span><span class="p">,</span>
        <span class="s1">&#39;md5&#39;</span><span class="p">:</span> <span class="s1">&#39;fa75699e90414af021442c21a62c3abf&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># copy ILSVRC/ImageSets/CLS-LOC/train_cls.txt to ./root/</span>
<span class="c1"># to skip os walk (it&#39;s too slow) using ILSVRC/ImageSets/CLS-LOC/train_cls.txt file</span>
<div class="viewcode-block" id="ImageNetFolder"><a class="viewcode-back" href="../../../../api/archai.datasets.providers.html#archai.datasets.providers.imagenet_folder.ImageNetFolder">[docs]</a><span class="k">class</span> <span class="nc">ImageNetFolder</span><span class="p">(</span><span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">ImageFolder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;`ImageNetFolder &lt;http://image-net.org/&gt;`_ 2012 Classification Dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        root (string): Root directory of the ImageNet Dataset.</span>
<span class="sd">        split (string, optional): The dataset split, supports ``train``, or ``val``.</span>
<span class="sd">        download (bool, optional): If true, downloads the dataset from the internet and</span>
<span class="sd">            puts it in root directory. If dataset is already downloaded, it is not</span>
<span class="sd">            downloaded again.</span>
<span class="sd">        transform (callable, optional): A function/transform that  takes in an PIL image</span>
<span class="sd">            and returns a transformed version. E.g, ``transforms.RandomCrop``</span>
<span class="sd">        target_transform (callable, optional): A function/transform that takes in the</span>
<span class="sd">            target and transforms it.</span>
<span class="sd">        loader (callable, optional): A function to load an image given its path.</span>

<span class="sd">     Attributes:</span>
<span class="sd">        classes (list): List of the class names.</span>
<span class="sd">        class_to_idx (dict): Dict with items (class_name, class_index).</span>
<span class="sd">        wnids (list): List of the WordNet IDs.</span>
<span class="sd">        wnid_to_idx (dict): Dict with items (wordnet_id, class_index).</span>
<span class="sd">        imgs (list): List of (image path, class_index) tuples</span>
<span class="sd">        targets (list): The class_index value for each image in the dataset</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_split</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
        <span class="n">wnid_to_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_meta_file</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># to skip os walk (it&#39;s too slow) using ILSVRC/ImageSets/CLS-LOC/train_cls.txt file</span>
        <span class="n">listfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;train_cls.txt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">listfile</span><span class="p">):</span>
            <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">VisionDataset</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">listfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">datalist</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="p">]</span>

            <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datalist</span><span class="p">]))</span>
            <span class="n">classes</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">class_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">))}</span>

            <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;.JPEG&#39;</span><span class="p">),</span> <span class="n">class_to_idx</span><span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datalist</span>
            <span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">default_loader</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">folder</span><span class="o">.</span><span class="n">IMG_EXTENSIONS</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="n">classes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">class_to_idx</span> <span class="o">=</span> <span class="n">class_to_idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">samples</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">ImageNetFolder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>

        <span class="n">idcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wnids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wnid_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">wnid</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">wnid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idcs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wnids</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">wnid_to_classes</span><span class="p">[</span><span class="n">wnid</span><span class="p">]</span> <span class="k">for</span> <span class="n">wnid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wnids</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="bp">cls</span><span class="p">:</span> <span class="n">idx</span>
                             <span class="k">for</span> <span class="n">clss</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">idcs</span><span class="p">)</span>
                             <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">clss</span><span class="p">}</span>

<div class="viewcode-block" id="ImageNetFolder.download"><a class="viewcode-back" href="../../../../api/archai.datasets.providers.html#archai.datasets.providers.imagenet_folder.ImageNetFolder.download">[docs]</a>    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_integrity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="p">):</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;tmp&#39;</span><span class="p">)</span>

            <span class="n">archive_dict</span> <span class="o">=</span> <span class="n">_ARCHIVE_DICT</span><span class="p">[</span><span class="s1">&#39;devkit&#39;</span><span class="p">]</span>
            <span class="n">download_and_extract_tar</span><span class="p">(</span><span class="n">archive_dict</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
                                     <span class="n">extract_root</span><span class="o">=</span><span class="n">tmpdir</span><span class="p">,</span>
                                     <span class="n">md5</span><span class="o">=</span><span class="n">archive_dict</span><span class="p">[</span><span class="s1">&#39;md5&#39;</span><span class="p">])</span>
            <span class="n">devkit_folder</span> <span class="o">=</span> <span class="n">_splitexts</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">archive_dict</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">_parse_devkit</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">,</span> <span class="n">devkit_folder</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_meta_file</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="p">)</span>

            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="p">):</span>
            <span class="n">archive_dict</span> <span class="o">=</span> <span class="n">_ARCHIVE_DICT</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">]</span>
            <span class="n">download_and_extract_tar</span><span class="p">(</span><span class="n">archive_dict</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
                                     <span class="n">extract_root</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="p">,</span>
                                     <span class="n">md5</span><span class="o">=</span><span class="n">archive_dict</span><span class="p">[</span><span class="s1">&#39;md5&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">==</span> <span class="s1">&#39;train&#39;</span><span class="p">:</span>
                <span class="n">_prepare_train_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span> <span class="o">==</span> <span class="s1">&#39;val&#39;</span><span class="p">:</span>
                <span class="n">val_wnids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_meta_file</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">_prepare_val_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="p">,</span> <span class="n">val_wnids</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">({</span><span class="s1">&#39;imagenet_download&#39;</span><span class="p">:</span>
                   <span class="sa">f</span><span class="s1">&#39;dir &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">split_folder</span><span class="si">}</span><span class="s1">&quot; already exist&#39;</span><span class="p">})</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meta_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;meta.bin&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_meta_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">check_integrity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Meta file not found or corrupted.&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;You can use download=True to create it.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_save_meta_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wnid_to_class</span><span class="p">,</span> <span class="n">val_wnids</span><span class="p">):</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">((</span><span class="n">wnid_to_class</span><span class="p">,</span> <span class="n">val_wnids</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">split</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_splits</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unknown split </span><span class="si">{}</span><span class="s2"> .&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Valid splits are {{}}.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_splits</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">split</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valid_splits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">split_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">)</span>

<div class="viewcode-block" id="ImageNetFolder.extra_repr"><a class="viewcode-back" href="../../../../api/archai.datasets.providers.html#archai.datasets.providers.imagenet_folder.ImageNetFolder.extra_repr">[docs]</a>    <span class="k">def</span> <span class="nf">extra_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Split: </span><span class="si">{split}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span></div></div>



<span class="k">def</span> <span class="nf">_parse_devkit</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">idx_to_wnid</span><span class="p">,</span> <span class="n">wnid_to_classes</span> <span class="o">=</span> <span class="n">_parse_meta</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">val_idcs</span> <span class="o">=</span> <span class="n">_parse_val_groundtruth</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
    <span class="n">val_wnids</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_to_wnid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">val_idcs</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">wnid_to_classes</span><span class="p">,</span> <span class="n">val_wnids</span>

<span class="k">def</span> <span class="nf">_parse_meta</span><span class="p">(</span><span class="n">devkit_root</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;meta.mat&#39;</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">scipy.io</span> <span class="k">as</span> <span class="nn">sio</span>

    <span class="n">metafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devkit_root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">sio</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">metafile</span><span class="p">,</span> <span class="n">squeeze_me</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;synsets&#39;</span><span class="p">]</span>
    <span class="n">nums_children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="p">))[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">num_children</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nums_children</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_children</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">idcs</span><span class="p">,</span> <span class="n">wnids</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="p">))[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">clss</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">clss</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">]</span>
    <span class="n">idx_to_wnid</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">wnid</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">wnid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">idcs</span><span class="p">,</span> <span class="n">wnids</span><span class="p">)}</span>
    <span class="n">wnid_to_classes</span> <span class="o">=</span> <span class="p">{</span><span class="n">wnid</span><span class="p">:</span> <span class="n">clss</span> <span class="k">for</span> <span class="n">wnid</span><span class="p">,</span> <span class="n">clss</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wnids</span><span class="p">,</span> <span class="n">classes</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">idx_to_wnid</span><span class="p">,</span> <span class="n">wnid_to_classes</span>


<span class="k">def</span> <span class="nf">_parse_val_groundtruth</span><span class="p">(</span><span class="n">devkit_root</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span>
                          <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;ILSVRC2012_validation_ground_truth.txt&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devkit_root</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">txtfh</span><span class="p">:</span>
        <span class="n">val_idcs</span> <span class="o">=</span> <span class="n">txtfh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">val_idcs</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_prepare_train_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">archive</span><span class="p">)</span> <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)]:</span>
        <span class="n">extract_tar</span><span class="p">(</span><span class="n">archive</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">archive</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_prepare_val_folder</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">wnids</span><span class="p">):</span>
    <span class="n">img_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)])</span>

    <span class="k">for</span> <span class="n">wnid</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">wnids</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">wnid</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">wnid</span><span class="p">,</span> <span class="n">img_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wnids</span><span class="p">,</span> <span class="n">img_files</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">img_file</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">wnid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_file</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">_splitexts</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
    <span class="n">exts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">while</span> <span class="n">ext</span><span class="p">:</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">exts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">root</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">exts</span><span class="p">))</span>
</pre></div>

          </div>
        </div>
      </div>
        <aside>

            
            <a href="../../../../index.html" id="logo" title=Archai><img class="logo" src="../../../../_static/logo.png" width="150px" height="150px" title=Archai /></a>
            
            
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installing Archai</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html">Archai Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../blitz.html">Archai - A 30 Minute Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../petridish.html">Petridish - Code Walkthrough</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Frequently Asked Questions (FAQs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dir_struct.html">Directory Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">APIs</a></li>
</ul>


            
            <ul>
                <li><a href="https://github.com/microsoft/archai">Github</a></li>
            </ul>
            
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </aside>
    
      <div class="clearer"></div>
    </div>
        <div class="footer">
            2020, Microsoft
        </div>

        
  </body>
</html>